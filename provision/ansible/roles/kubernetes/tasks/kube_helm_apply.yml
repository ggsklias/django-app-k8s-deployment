---
- name: Fetch the kubeconfig file
  become: true
  ansible.builtin.fetch:
    src: /etc/kubernetes/admin.conf
    dest: /tmp/kubeconfig
    flat: true

- name: Confirm file is fetched
  become: true
  ansible.builtin.shell: |
    ls -l /tmp/kubeconfig
    cat /tmp/kubeconfig
  changed_when: false
  delegate_to: localhost

- name: Deploy Django application via Helm (unified release)
  kubernetes.core.helm:
    name: django-release
    chart_ref: /home/{{ ansible_user }}/helm/djangoarticleapp
    release_namespace: production
    kubeconfig: /tmp/kubeconfig
    values:
      createGitlabRegistrySecret: true
      docker_config:
        auths:
          registry.gitlab.com:
            username: "{{ lookup('env', 'GITLAB_USERNAME') }}"
            password: "{{ lookup('env', 'GITLAB_REGISTRY_TOKEN') }}"
            email: "{{ lookup('env', 'GITLAB_EMAIL') }}"
            auth: "{{ (lookup('env', 'GITLAB_USERNAME') + ':' + lookup('env', 'GITLAB_REGISTRY_TOKEN')) | b64encode }}"
      django:
        image:
          repository: "{{ lookup('env', 'CI_REGISTRY_IMAGE') }}"
          tag: "{{ lookup('env', 'CI_COMMIT_SHA') | default('latest') }}"
  delegate_to: localhost
